{
  "hash": "523c377f3e28d794a52a9110290d7ad7",
  "result": {
    "markdown": "---\ntitle: \"Class 15 Code\"\nauthor: \"Nicky Wakim\"\ndate: \"2023-05-31\"\noutput: html_document\n---\n\n```{=html}\n<style type=\"text/css\">\n.main-container {\n  max-width: 1100px;\n  margin-left: auto;\n  margin-right: auto;\n}\n</style>\n```\n\n```{=html}\n<style type=\"text/css\">\nbody, td {\n   font-size: 16px;\n}\ncode.r{\n  font-size: 16px;\n}\npre {\n  font-size: 16px\n}\n</style>\n```\n\n### Set up for the code\n\nThis includes the `LogisticDx` functions. The package `LogisticDx` was not installing on my computer, and as far as I know, not working for newer versions of R in general. I have emailed the maintainer of the package to see if they can update the package and get it working for newer versions of R. In the meantime, I have copied specific functions into the file `Logistic_Dx_Functions.R`. We will need to `source()` the R script so that we can use the functions. Please make sure you download the `Logistic_Dx_Functions.R` and include the needed file location to run it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(epiDisplay)\nlibrary(kableExtra)\nlibrary(ggplot2)\nlibrary(aplore3)\nlibrary(GGally)\nlibrary(mfp)\nlibrary(ResourceSelection)\nlibrary(DescTools)\nsource(\"Logistic_Dx_Functions.R\") # Edit this if your file is not in the same folder as this Rmd file\n```\n:::\n\n\n# GLOW study example\n\nThe GLOW study data is already a part of the `aplore3` package (stands for the \"**Ap**plied **Lo**gistic **Re**gression **3**rd Edition).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglow = glow500\n```\n:::\n\n\n# Overall Measures of Fit\n\n## Pearson Residuals\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglow2 = glow %>% mutate(raterisk2 = factor(raterisk, levels = c(\"Less\", \"Same\", \"Greater\"), \n                                            labels = c(\"Less and Same\", \"Less and Same\", \"Greater\")), \n                        frac_num = as.numeric(fracture)-1) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncat_model = glm(frac_num ~ priorfrac + momfrac + \n                  armassist + raterisk2 + \n                  momfrac*armassist, \n                 data = glow2, family = \"binomial\")\n\n#gof(cat_model)$chiSq\n\nhoslem.test(glow2$frac_num, fitted(cat_model), g = 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tHosmer and Lemeshow goodness of fit (GOF) test\n\ndata:  glow2$frac_num, fitted(cat_model)\nX-squared = 1.5918, df = 4, p-value = 0.8103\n```\n:::\n:::\n\n\n## AIC and BIC\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprelim_final = glm(fracture ~ age + height + priorfrac + \n                     momfrac + armassist + raterisk2 + \n                     age*priorfrac + momfrac*armassist, \n                 data = glow2, family = binomial)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nAIC(prelim_final)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 518.4966\n```\n:::\n\n```{.r .cell-code}\nBIC(prelim_final)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 556.4281\n```\n:::\n\n```{.r .cell-code}\ncat_model = glm(frac_num ~ priorfrac + momfrac + \n                  armassist + raterisk2 + \n                  momfrac*armassist, \n                 data = glow2, family = \"binomial\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nAIC(cat_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 535.9395\n```\n:::\n\n```{.r .cell-code}\nBIC(cat_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 561.2272\n```\n:::\n:::\n\n\n# Logistic Regression Diagnostics\n\nFit the preliminary final model first. Then we use the `dx` function to extract the diagnostic values from the covariate patterns.\n\n::: {.cell}\n\n```{.r .cell-code}\nprelim_final = glm(fracture ~ age + height + priorfrac + \n                     momfrac + armassist + raterisk2 + \n                     age*priorfrac + momfrac*armassist, \n                 data = glow2, family = binomial)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndiagnost_pf = dx(prelim_final)\nhead(diagnost_pf)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nKey: <dBhat>\n   (Intercept)   age height priorfracYes momfracYes armassistYes\n         <num> <num>  <num>        <num>      <num>        <num>\n1:           1    57    171            0          0            0\n2:           1    59    176            0          0            0\n3:           1    57    199            0          0            0\n4:           1    56    168            0          0            0\n5:           1    59    170            0          0            0\n6:           1    58    168            0          0            0\n   raterisk2Greater age:priorfracYes momfracYes:armassistYes     y          P\n              <num>            <num>                   <num> <num>      <num>\n1:                0                0                       0     0 0.04706516\n2:                0                0                       0     0 0.04200413\n3:                1                0                       0     0 0.02088401\n4:                0                0                       0     0 0.05092595\n5:                0                0                       0     0 0.05485440\n6:                0                0                       0     0 0.05675974\n       n       yhat         Pr         dr           h        sPr        sdr\n   <int>      <num>      <num>      <num>       <num>      <num>      <num>\n1:     1 0.04706516 -0.2222379 -0.3105117 0.004847631 -0.2227786 -0.3112671\n2:     1 0.04200413 -0.2093940 -0.2929567 0.005641605 -0.2099872 -0.2937866\n3:     1 0.02088401 -0.1460461 -0.2054515 0.011690129 -0.1469073 -0.2066630\n4:     1 0.05092595 -0.2316432 -0.3233217 0.004718747 -0.2321917 -0.3240872\n5:     1 0.05485440 -0.2409109 -0.3359056 0.004748526 -0.2414849 -0.3367060\n6:     1 0.05675974 -0.2453065 -0.3418603 0.004595772 -0.2458721 -0.3426486\n       dChisq       dDev        dBhat\n        <num>      <num>        <num>\n1: 0.04963029 0.09688718 0.0002417613\n2: 0.04409460 0.08631056 0.0002501757\n3: 0.02158174 0.04270960 0.0002552776\n4: 0.05391297 0.10503253 0.0002556078\n5: 0.05831496 0.11337093 0.0002782313\n6: 0.06045310 0.11740808 0.0002791114\n```\n:::\n\n```{.r .cell-code}\ndim(diagnost_pf)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 457  21\n```\n:::\n:::\n\n\nPlot the change in standardized Pearson residuals against the estimated/predicted probabilities. Remember, this is the change in the \n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(diagnost_pf) + geom_point(aes(x=P, y=dChisq)) + \n  xlab(\"Estimated/Predicted Probability of Fracture\") +\n  ylab(\"Change in Std. Pearson Residual\") +\n  theme(text = element_text(size = 16))\n```\n\n::: {.cell-output-display}\n![](Class_15_code_files/figure-html/unnamed-chunk-10-1.png){width=576}\n:::\n:::\n\n\nPlot the change in standardized deviance residuals against the estimated/predicted probabilities. \n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(diagnost_pf) + geom_point(aes(x=P, y=dDev)) + \n  xlab(\"Estimated/Predicted Probability of Fracture\") +\n  ylab(\"Change in Std. Deviance Residual\") +\n  theme(text = element_text(size = 16))\n```\n\n::: {.cell-output-display}\n![](Class_15_code_files/figure-html/unnamed-chunk-11-1.png){width=576}\n:::\n:::\n\n\nPlot the change in coefficient estimates against the estimated/predicted probabilities. \n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(diagnost_pf) + geom_point(aes(x=P, y=dBhat)) + \n  xlab(\"Estimated/Predicted Probability of Fracture\") +\n  ylab(\"Change in Coefficient Estimates\") +\n  theme(text = element_text(size = 16))\n```\n\n::: {.cell-output-display}\n![](Class_15_code_files/figure-html/unnamed-chunk-12-1.png){width=576}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(diagnost_pf) + geom_point(aes(x=P, y=h)) + \n  xlab(\"Estimated/Predicted Probability of Fracture\") +\n  ylab(\"Change in Coefficient Estimates\") +\n  theme(text = element_text(size = 16))\n```\n\n::: {.cell-output-display}\n![](Class_15_code_files/figure-html/unnamed-chunk-13-1.png){width=576}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndiagnost_points = diagnost_pf %>% \n  mutate(Cov_patt = 1:nrow(.)) %>%\n  filter((sPr)^2 > 12.5 | (sdr)^2 > 4 | dBhat > 0.125) %>%\n  dplyr::select(Cov_patt, y, P, h, dChisq, dDev, dBhat) %>%\n  round(., 2)\nkable(diagnost_points) %>% kable_styling(bootstrap_options = c(\"striped\", \"hover\"), full_width = F)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> Cov_patt </th>\n   <th style=\"text-align:right;\"> y </th>\n   <th style=\"text-align:right;\"> P </th>\n   <th style=\"text-align:right;\"> h </th>\n   <th style=\"text-align:right;\"> dChisq </th>\n   <th style=\"text-align:right;\"> dDev </th>\n   <th style=\"text-align:right;\"> dBhat </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 340 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.13 </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n   <td style=\"text-align:right;\"> 6.78 </td>\n   <td style=\"text-align:right;\"> 4.11 </td>\n   <td style=\"text-align:right;\"> 0.03 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 350 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.12 </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n   <td style=\"text-align:right;\"> 7.03 </td>\n   <td style=\"text-align:right;\"> 4.18 </td>\n   <td style=\"text-align:right;\"> 0.03 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 391 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.09 </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n   <td style=\"text-align:right;\"> 10.67 </td>\n   <td style=\"text-align:right;\"> 4.93 </td>\n   <td style=\"text-align:right;\"> 0.05 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 412 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.13 </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n   <td style=\"text-align:right;\"> 6.67 </td>\n   <td style=\"text-align:right;\"> 4.10 </td>\n   <td style=\"text-align:right;\"> 0.06 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 426 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.13 </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n   <td style=\"text-align:right;\"> 6.59 </td>\n   <td style=\"text-align:right;\"> 4.08 </td>\n   <td style=\"text-align:right;\"> 0.07 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 428 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.06 </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n   <td style=\"text-align:right;\"> 16.10 </td>\n   <td style=\"text-align:right;\"> 5.70 </td>\n   <td style=\"text-align:right;\"> 0.07 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 436 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.09 </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n   <td style=\"text-align:right;\"> 10.23 </td>\n   <td style=\"text-align:right;\"> 4.86 </td>\n   <td style=\"text-align:right;\"> 0.08 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 453 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.74 </td>\n   <td style=\"text-align:right;\"> 0.05 </td>\n   <td style=\"text-align:right;\"> 2.91 </td>\n   <td style=\"text-align:right;\"> 2.79 </td>\n   <td style=\"text-align:right;\"> 0.14 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 454 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:right;\"> 0.24 </td>\n   <td style=\"text-align:right;\"> 0.03 </td>\n   <td style=\"text-align:right;\"> 6.56 </td>\n   <td style=\"text-align:right;\"> 5.89 </td>\n   <td style=\"text-align:right;\"> 0.17 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 455 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.21 </td>\n   <td style=\"text-align:right;\"> 0.04 </td>\n   <td style=\"text-align:right;\"> 3.97 </td>\n   <td style=\"text-align:right;\"> 3.28 </td>\n   <td style=\"text-align:right;\"> 0.18 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 456 </td>\n   <td style=\"text-align:right;\"> 0 </td>\n   <td style=\"text-align:right;\"> 0.75 </td>\n   <td style=\"text-align:right;\"> 0.06 </td>\n   <td style=\"text-align:right;\"> 3.13 </td>\n   <td style=\"text-align:right;\"> 2.92 </td>\n   <td style=\"text-align:right;\"> 0.19 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 457 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.17 </td>\n   <td style=\"text-align:right;\"> 0.04 </td>\n   <td style=\"text-align:right;\"> 4.93 </td>\n   <td style=\"text-align:right;\"> 3.64 </td>\n   <td style=\"text-align:right;\"> 0.22 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndiagnost_points2 = diagnost_pf %>% \n  mutate(Cov_patt = 1:nrow(.)) %>%\n  filter(Cov_patt %in% c(391, 428, 436, 454)) %>%\n  round(., 2)\nglow3 = glow2 %>%\n  filter(!(age == 65 & height == 167 & priorfrac == \"No\"))\n```\n:::\n",
    "supporting": [
      "Class_15_code_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}