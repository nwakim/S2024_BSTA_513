{
  "hash": "be4b47f2ef1dcd9543d43d128bce4815",
  "result": {
    "markdown": "---\ntitle: \"Class 9 Code\"\nauthor: \"Nicky Wakim\"\ndate: \"2023-04-26\"\noutput: html_document\n---\n\n<style type=\"text/css\">\n.main-container {\n  max-width: 850px;\n  margin-left: auto;\n  margin-right: auto;\n}\n</style>\n\n<style type=\"text/css\">\nbody, td {\n   font-size: 16px;\n}\ncode.r{\n  font-size: 16px;\n}\npre {\n  font-size: 16px\n}\n</style>\n\n### Set up for the code\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyr)\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'dplyr'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n:::\n\n```{.r .cell-code}\nlibrary(epiDisplay)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: foreign\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: survival\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: MASS\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'MASS'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:dplyr':\n\n    select\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: nnet\n```\n:::\n\n```{.r .cell-code}\nlibrary(kableExtra)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'kableExtra'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:dplyr':\n\n    group_rows\n```\n:::\n\n```{.r .cell-code}\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nhere() starts at /Users/wakim/Library/CloudStorage/OneDrive-OregonHealth&ScienceUniversity/Teaching/Classes/S2024_BSTA_513_613/S2024_BSTA_513\n```\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'ggplot2'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:epiDisplay':\n\n    alpha\n```\n:::\n\n```{.r .cell-code}\nload(here(\"data\", \"bc_diagnosis.Rda\"))\n```\n:::\n\n\n## GLOW study example\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(aplore3)\nglow = glow500\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglow_m1 = glm(fracture ~ priorfrac, data = glow, family = binomial)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglow_m2 = glm(fracture ~ priorfrac + age, data = glow, family = binomial)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglow_m3 = glm(fracture ~ priorfrac + age + priorfrac*age, data = glow, family = binomial)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(glow_m1); summary(glow_m2); summary(glow_m3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = fracture ~ priorfrac, family = binomial, data = glow)\n\nCoefficients:\n             Estimate Std. Error z value Pr(>|z|)    \n(Intercept)   -1.4167     0.1305 -10.859  < 2e-16 ***\npriorfracYes   1.0638     0.2231   4.769 1.85e-06 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 562.34  on 499  degrees of freedom\nResidual deviance: 540.07  on 498  degrees of freedom\nAIC: 544.07\n\nNumber of Fisher Scoring iterations: 4\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = fracture ~ priorfrac + age, family = binomial, \n    data = glow)\n\nCoefficients:\n             Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  -4.21429    0.84784  -4.971 6.67e-07 ***\npriorfracYes  0.83884    0.23416   3.582 0.000340 ***\nage           0.04119    0.01218   3.382 0.000719 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 562.34  on 499  degrees of freedom\nResidual deviance: 528.52  on 497  degrees of freedom\nAIC: 534.52\n\nNumber of Fisher Scoring iterations: 4\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = fracture ~ priorfrac + age + priorfrac * age, family = binomial, \n    data = glow)\n\nCoefficients:\n                 Estimate Std. Error z value Pr(>|z|)    \n(Intercept)      -5.68942    1.08408  -5.248 1.54e-07 ***\npriorfracYes      4.96134    1.81022   2.741  0.00613 ** \nage               0.06251    0.01546   4.043 5.27e-05 ***\npriorfracYes:age -0.05738    0.02501  -2.294  0.02179 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 562.34  on 499  degrees of freedom\nResidual deviance: 523.27  on 496  degrees of freedom\nAIC: 531.27\n\nNumber of Fisher Scoring iterations: 4\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nprior_age = expand_grid(priorfrac = c(\"No\", \"Yes\"), \n                        age = 55:90)\nnewdata = with(glow, data.frame(prior_age))\nfrac_pred = predict(glow_m3, newdata, se.fit = T, type=\"response\")\npred_glow = newdata %>% mutate(frac_pred = frac_pred$fit)\nggplot(pred_glow) + #geom_point(aes(x = age, y = frac_pred, color = priorfrac)) +\n  geom_smooth(method = \"loess\", aes(x = age, y = frac_pred, color = priorfrac)) +\n  theme(legend.position = \"right\", \n        text = element_text(size=20), \n        title = element_text(size=16)) +\n  scale_color_discrete(name = \"Prior Fracture\") +\n  xlab(\"Age (years)\") + ylab(\"Predicted Probability of Fracture\") +\n  ylim(0,1)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](Class_9_code_files/figure-html/unnamed-chunk-7-1.png){width=768}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nprior_age = expand_grid(priorfrac = c(\"No\", \"Yes\"), \n                        age = 55:90)\nnewdata = with(glow, data.frame(prior_age))\nfrac_pred_log = predict(glow_m3, newdata, se.fit = T, type=\"link\")\npred_glow2 = newdata %>% mutate(frac_pred_log = frac_pred_log$fit)\nggplot(pred_glow2) + #geom_point(aes(x = age, y = frac_pred, color = priorfrac)) +\n  geom_smooth(method = \"loess\", aes(x = age, y = frac_pred_log, color = priorfrac)) +\n  theme(legend.position = \"right\", \n        text = element_text(size=20), \n        title = element_text(size=16)) +\n  scale_color_discrete(name = \"Prior Fracture\") +\n  xlab(\"Age (years)\") + ylab(\"Log-Odds of Fracture\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](Class_9_code_files/figure-html/unnamed-chunk-8-1.png){width=768}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nage = 55:90\nlogit_OR = glow_m3$coefficients[2] + glow_m3$coefficients[4]*age\nOR_data = data.frame(Age = age, OR = exp(logit_OR))\nggplot(OR_data) + \n  geom_hline(yintercept=1, color = \"#65A43D\", size = 1.5) +\n  geom_smooth(method = \"loess\", aes(x = Age, y = OR), color = \"black\", size = 2) +\n  theme(legend.position = \"right\", \n        text = element_text(size=20), \n        title = element_text(size=16)) +\n  xlab(\"Age (years)\") + ylab(\"Odds Ratio\") +\n  ylim(0, 10)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nâ„¹ Please use `linewidth` instead.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](Class_9_code_files/figure-html/unnamed-chunk-9-1.png){width=576}\n:::\n:::\n\n\n\n### Interaction model - Poll Everywhere\n\n::: {.cell}\n\n```{.r .cell-code}\ninter_bc = glm(Late_stage_diag ~ Race_Ethnicity + Age + Race_Ethnicity*Age, data = bc, \n               family = binomial())\nsummary(inter_bc)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = Late_stage_diag ~ Race_Ethnicity + Age + Race_Ethnicity * \n    Age, family = binomial(), data = bc)\n\nCoefficients:\n                                                     Estimate Std. Error\n(Intercept)                                         -4.540270   0.242635\nRace_EthnicityHispanic-Latino                        0.317162   0.733038\nRace_EthnicityNH American Indian/Alaskan Native     -4.104745   5.085605\nRace_EthnicityNH Asian/Pacific Islander              0.532264   0.719711\nRace_EthnicityNH Black                              -0.337456   0.657331\nAge                                                  0.056762   0.003806\nRace_EthnicityHispanic-Latino:Age                   -0.005279   0.011561\nRace_EthnicityNH American Indian/Alaskan Native:Age  0.062026   0.077179\nRace_EthnicityNH Asian/Pacific Islander:Age         -0.006314   0.011338\nRace_EthnicityNH Black:Age                           0.011035   0.010350\n                                                    z value Pr(>|z|)    \n(Intercept)                                         -18.712   <2e-16 ***\nRace_EthnicityHispanic-Latino                         0.433    0.665    \nRace_EthnicityNH American Indian/Alaskan Native      -0.807    0.420    \nRace_EthnicityNH Asian/Pacific Islander               0.740    0.460    \nRace_EthnicityNH Black                               -0.513    0.608    \nAge                                                  14.913   <2e-16 ***\nRace_EthnicityHispanic-Latino:Age                    -0.457    0.648    \nRace_EthnicityNH American Indian/Alaskan Native:Age   0.804    0.422    \nRace_EthnicityNH Asian/Pacific Islander:Age          -0.557    0.578    \nRace_EthnicityNH Black:Age                            1.066    0.286    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 11861  on 9999  degrees of freedom\nResidual deviance: 11481  on 9990  degrees of freedom\nAIC: 11501\n\nNumber of Fisher Scoring iterations: 4\n```\n:::\n\n```{.r .cell-code}\nwald_test = summary(inter_bc)$coefficients\nrownames(wald_test) = c(\"Intercept\", \"R_E: HL\", \"R_E: NH AIAN\",\n                        \"R_E: NH API\",\"R_E: NH B\", \"Age\", \n                        \"R_E: HL * Age\", \"R_E: NH AIAN * Age\",\n                        \"R_E: NH API * Age\",\"R_E: NH B * Age\")\nround(wald_test, 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                   Estimate Std. Error z value Pr(>|z|)\nIntercept            -4.540      0.243 -18.712    0.000\nR_E: HL               0.317      0.733   0.433    0.665\nR_E: NH AIAN         -4.105      5.086  -0.807    0.420\nR_E: NH API           0.532      0.720   0.740    0.460\nR_E: NH B            -0.337      0.657  -0.513    0.608\nAge                   0.057      0.004  14.913    0.000\nR_E: HL * Age        -0.005      0.012  -0.457    0.648\nR_E: NH AIAN * Age    0.062      0.077   0.804    0.422\nR_E: NH API * Age    -0.006      0.011  -0.557    0.578\nR_E: NH B * Age       0.011      0.010   1.066    0.286\n```\n:::\n:::\n",
    "supporting": [
      "Class_9_code_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}